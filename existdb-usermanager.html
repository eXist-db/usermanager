<link rel="import" href="bower_components/polymer/polymer-element.html">
<link rel="import" href="bower_components/polymer/lib/elements/array-selector.html">
<link rel="import" href="bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="bower_components/iron-pages/iron-pages.html">
<link rel="import" href="bower_components/paper-styles/color.html">
<link rel="import" href="bower_components/paper-styles/typography.html">
<link rel="import" href="bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="bower_components/iron-icons/iron-icons.html">
<link rel="import" href="bower_components/iron-icons/social-icons.html">
<link rel="import" href="bower_components/iron-icon/iron-icon.html">
<link rel="import" href="bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="bower_components/paper-input/paper-input.html">
<link rel="import" href="bower_components/paper-password-input/paper-password-input.html">
<link rel="import" href="bower_components/paper-password-input/match-passwords-validator.html">
<link rel="import" href="bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="bower_components/paper-item/paper-item.html">
<link rel="import" href="bower_components/paper-button/paper-button.html">
<link rel="import" href="bower_components/paper-fab/paper-fab.html">
<link rel="import" href="bower_components/paper-toast/paper-toast.html">
<link rel="import" href="bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="bower_components/iron-form/iron-form.html">

<link rel="import" href="existdb-user.html">



<link rel="import" href="bower_components/app-layout/app-drawer/app-drawer.html">


<script src="bower_components/jquery/dist/jquery.min.js"></script>
<script src="bower_components/velocity/velocity.min.js"></script>
<script src="bower_components/velocity/velocity.ui.min.js"></script>



<dom-module id="existdb-usermanager">
    <template>
        <style>
            :host {
                --paper-tabs-selection-bar-color: var(--paper-grey-900);
                @apply(--paper-font-common-base);
                display: block;
                padding: 0;
                margin: 0;
                width: 100%;
                height: 100%;
                --iron-icon-fill-color: var(--paper-grey-500);
                --iron-icon-width: 62px;
                --iron-icon-height: 62px;
                --paper-icon-button-ink-color: var(--paper-grey-700);
                /*max-width: 600;*/
            }
            app-header{
                background: rgb(0, 136, 204);
                padding:0px;
                color:white;
            }

            paper-fab {
                position: absolute;
                right: 20px;
                top:-10px;
                --paper-fab-background: var(--paper-pink-500);
                --iron-icon-fill-color: var(--paper-grey-50);
            }

            paper-icon-button{
                width: 48px;
                height: 48px;
                background: var(--paper-grey-200);
                border-radius:24px;
            }

            h1{
                @apply(--paper-font-headline);
                padding-left:20px;
            }
            h2{
                @apply(--paper-font-headline);
            }

            ul {
                padding: 0 40px;
                list-style: none;
            }

            li {
                padding: 10px;
                background: var(--paper-grey-50);
                margin: 10px 0;
                position: relative;
            }

            .user, .group {
                font-weight: 500;
                font-size: 20px;
                @apply(--paper-font-common-code);

            }

            .fullname, .description {
                display: block;
                font-size: 12px;
            }


            paper-icon-button.more {
                position: absolute;
                top: 10px;
                right: 10px;
            }

            .details {
                padding: 40px;
                margin: 20px 40px 20px 0;
                background: white;
            }

            .details paper-input {
                @apply(--paper-font-body1);
            }

            .accountActive {
                margin: 10px 0;
            }

            ul.groupMembers li {
                background: var(--paper-blue-500);
                color: white;
                position: relative;
            }

            .member-heading {
                margin-top: 20px;
            }

            .group-member {
                padding: 16px;
            }

            ul.groupMembers li .remove-group {
                position: absolute;
                right: 10px;
                top: 0;
            }

            paper-input, paper-password-input {
                --paper-input-container: {
                    padding: 4px 0;
                };
                padding: 4px 0;

            }

            .details paper-input-container {
                padding: 4px 0;
            }

            paper-item {
                min-height: 28px;
            }

            paper-item.iron-selected {
                background: var(--paper-blue-grey-200);
                color: var(--paper-blue-gray-900);
            }

            paper-menu-button {
                position: relative;
                float: right;
            }

            paper-icon-button.addGroup {
                position: absolute;
                top: -30px;
                right: 10px;
            }

            paper-button.save {
                background: var(--paper-blue-500);
                color: white;
                margin-left: 0;
                margin-top: 10px;
            }

            paper-button.delete {
                background: var(--paper-red-500);
                color: white;
                float: right;
                margin-right: 0;
                margin-top: 10px;
            }

            .membersOfGroup {
                position: relative;
                padding: 0;
            }

            .membersHeader {
                padding: 0;
            }

            .membersOfGroup paper-toggle-button {
                position: absolute;
                right: 10px;
                top: 12px;
            }

            .membersOfGroup span {
                width: 50%;
            }

            ul li:last-child {
                background: transparent;
            }


            paper-listbox.groupsOfUser {
                border: 1px solid var(--paper-grey-300);
            }

            .user-entry {
                min-height: 54px;
                position: relative;
                padding: 10px 10px 10px 100px;
            }

            .user-icon {
                position: absolute;
                left: 10px;
                top: 10px;
            }

            paper-toggle-button.accountActive {
                margin-top: 20px;
                --paper-toggle-button-checked-button-color: var(--paper-red-600);
            }

            paper-toast {
                width: 100%;
                margin: 0;
                font-size: 20px;
            }

            paper-toast.errorReporter {
                top: 0;
                --paper-toast-background-color: var(--paper-red-500);
                --paper-toast-color: white;
            }

            .editUser{
                width:100%;
                height: 100%;
            }
            paper-icon-button.user-back{
                float:right;
                margin-right:40px;
                display: block;
            }

        </style>

        <iron-ajax id="loadUserList"
                   with-credentials
                   method="get"
                   handle-as="json"
                   on-response="_handleUsers"
                   url="/exist/apps/existdb-usermanager/api/user/"
                   on-error="_handleRequestError"
                   auto></iron-ajax>

        <iron-ajax id="saveUser"
                   with-credentials
                   method="put"
                   handle-as="json"
                   on-response="_handleUserSaved"
                   content-type="application/json"
                   url="/exist/apps/existdb-usermanager/api/user/"
                   on-error="_handleRequestError"></iron-ajax>

        <iron-ajax id="deleteUser"
                   with-credentials
                   method="delete"
                   handle-as="json"
                   on-response="_handleUserDeleted"
                   content-type="application/json"
                   url="/exist/apps/existdb-usermanager/api/user/"
                   on-error="_handleRequestError"></iron-ajax>

        <iron-ajax id="loadGroupList"
                   verbose with-credentials
                   method="get" handle-as="json"
                   on-response="_handleGroups"
                   url="/exist/apps/existdb-usermanager/api/group/"
                   on-error="_handleRequestError"
        ></iron-ajax>

        <array-selector id="selector" items="{{users}}" selected="{{selectedUser}}" multi toggle></array-selector>

        <app-header-layout>
            <app-header slot="header" fixed>
                <h1>User Manager</h1>
                <paper-fab id="addUser" icon="add" on-tap="_handleAddUser"></paper-fab>
                <paper-tabs selected="{{selected}}">
                    <paper-tab>Users</paper-tab>
                    <paper-tab>Groups</paper-tab>
                </paper-tabs>

            </app-header>
            <div id="wrapper">


                <iron-pages id="pages" selected="[[selected]]">
                    <ul>
                        <template id="userList" is="dom-repeat" items="{{users}}" as="item">

                            <li class="user-entry">
                                <iron-icon class="icon user-icon" icon="social:person"></iron-icon>
                                <span class="user" title="User Name">{{item.user}}</span>
                                <span class="fullname">{{item.fullName}}</span>
                                <span class="description">{{item.description}}</span>
                                <paper-icon-button id="moredetail" class="more" icon="arrow-forward" on-click="_editUser"></paper-icon-button>
                            </li>
                        </template>
                    </ul>
                    <ul>
                        <template id="groupList" is="dom-repeat" items="{{groups}}" as="item">
                            <li>
                                <iron-icon class="icon" icon="social:people"></iron-icon>
                                <span class="group" title="Group">{{item.group}}</span>
                                <span class="description">{{item.description}}</span>
                                <paper-icon-button class="more" icon="expand-more" on-tap="editGroup"></paper-icon-button>
                                <div class="details" hidden>
                                    <div class="details">
                                        <paper-input label="Group Name" value="{{item.group}}"></paper-input>
                                        <paper-input label="Description" value="{{item.description}}"></paper-input>
                                        <paper-item class="membersHeader">
                                            <span style="width: 50%;">Users in this Group</span>
                                            <span style="width: 50%;text-align: right;display: inline-block;">Group Manager</span>
                                        </paper-item>
                                        <template is="dom-repeat" items="{{item.groups}}" as="member">
                                            <paper-item class="membersOfGroup">
                                                <span>{{member.member}}</span>
                                                <paper-toggle-button checked$="{{member.isManager}}"></paper-toggle-button>
                                            </paper-item>
                                        </template>
                                        <paper-button id="saveGroup" class="save" on-tap="_handleSaveGroup">save changes
                                        </paper-button>

                                        </table>
                                        <!--<paper-toggle-button value="[[item.disabled]]">Account is disabled</paper-toggle-button>-->

                                    </div>
                                </div>
                            </li>
                        </template>
                        <li>
                            <paper-fab id="addGroup" mini icon="add" on-tap="_handleAddGroup"></paper-fab>
                        </li>

                    </ul>
                    <div class="editUser">
                        <paper-icon-button class="user-back" icon="arrow-back" on-click="_back" autofocus></paper-icon-button>

                        <div class="details">
                            <h2>User</h2>
                            <iron-form id="userForm" allow-redirect="false">
                                <form action="" method="">
                                    <paper-input id="userInput" label="User Name" value="{{selectedUser.user}}"
                                                 class="username" required></paper-input>
                                    <paper-input label="Full Name" value="{{selectedUser.fullName}}"></paper-input>
                                    <paper-input label="Description" value="{{selectedUser.description}}"></paper-input>

                                    <match-passwords-validator id="match-passwords-validator" password="[[selectedUser.password]]"></match-passwords-validator>
                                    <paper-password-input label="Password"
                                                          value="{{selectedUser.password}}"></paper-password-input>
                                    <paper-password-input id="confirm" label="Confirm" auto-validate
                                                          validator="match-passwords-validator"
                                                          error-message="Passwords need to match"></paper-password-input>

                                    <paper-toggle-button class="accountActive" checked$="{{selectedUser.disabled}}">Account is disabled</paper-toggle-button>
                                    <paper-input label="umask" value="{{selectedUser.umask}}"></paper-input>

                                    <div class="member-heading">Member of groups</div>
                                    <paper-listbox id="memberOf" class="groupsOfUser" multi attr-for-selected="label">
                                        <template is="dom-repeat" items="{{groups}}" as="member">
                                            <paper-item label="{{member.group}}">
                                                {{member.group}}
                                            </paper-item>
                                        </template>
                                    </paper-listbox>
                                    <paper-button id="save" class="save" on-tap="_handleSaveUser">save</paper-button>
                                    <paper-button id="delete" class="delete" on-tap="_handleDeleteUser">delete user</paper-button>
                                </form>
                            </iron-form>
                        </div>

                    </div>
                </iron-pages>
            </div>


        </app-header-layout>
        <paper-toast id="messenger" class="messenger" text=""></paper-toast>
        <paper-toast id="errorReporter" class="errorReporter" text="" duration="0"></paper-toast>
    </template>

    <script>
        /**
         * `existdb-usermanager`
         *
         *
         * @customElement
         * @polymer
         * @demo demo/index.html
         */
        class ExistdbUsermanager extends Polymer.Element {

            static get is() {
                return 'existdb-usermanager';
            }

            static get properties() {
                return {
                    selected: {
                        type: Number,
                        value: 0,
                    },
                    users: {
                        type: Array,
                        notify: true,
                        observer: '_usersChanged',
                        value: []
                    },

                    selectedUser: {
                        type: Object,
                        value: {
                            user: 'foo',
                            fullName: 'bar',
                            password: '',
                            description: '',
                            umask: '',
                            disabled: false,
                            groups: [],

                        }
                    },
                    groups: {
                        type: Array,
                        notify: true,
                        observer: '_groupsChanged'
                    },
                    groupmember: {
                        type: Array,
                        value: []
                    },

                    userUrl: {
                        type: String,
                        value: "/exist/apps/existdb-usermanager/api/user/",
                        readonly: true
                    },
                    mode: {
                        type: String,
                        value: 'edit'
                    }
                };
            }

            connectedCallback() {
                super.connectedCallback();
            }

            ready(){
                super.ready();
            }


            // ########################## private part ##########################
            // ########################## private part ##########################
            // ########################## private part ##########################


            // ########## USER ##########
            // ########## USER ##########
            // ########## USER ##########
            _handleUsers() {
                console.log('_handleUsers', this.$.loadUserList.lastResponse)
                this.users = this.$.loadUserList.lastResponse
                this.$.loadGroupList.generateRequest();
            }

            _handleRequestError(e) {
                console.log("error loading users: ", e);
                console.log("error: ", this.$.loadUserList.lastError);
                var error = this.$.loadUserList.lastError;
                if (error.status == '403') {
                    this.$.errorReporter.text = "You don't have sufficient priviledges to access UserManager";
//                    this.$.errorReporter.open();
                } else {
                    this.$.errorReporter.text = 'Server responded: ' + error.status + ' message: ' + error.message;
                }
                this.$.errorReporter.open();

                //                this.$.wrapper.hidden = true;
            }

            // ##### USER FUNCTIONS #####
            _handleAddUser(e) {
                console.log("add user: ", e)
                console.log("dom repeat ", this.$.userList);
                e.stopPropagation();
                e.preventDefault();

                console.log("number of users before: ", this.users.length);

                var foo = this.push('users', {
                    user: '',
                    fullName: '',
                    description: '',
                    password: '',
                    disabled: false,
                    umask: '022',
                    groups: []
                })
                var userCnt = this.users.length;
                console.log("number of users after: ", this.users.length);
                console.log("number of users after: ", this.users[userCnt-1]);


                console.log('selected user: ', this.selectedUser);
                this._resetForm();
                this._selectGroups();
                this.$.pages.select(2);
            }

            _resetForm(){
                //reset eventual pre-existing values
                this.$.confirm.value = "";
                this.selectedUser = this.users[this.users.length-1];
            }

            _editUser(e) {
                console.log("edit user ", e.model.get('item.user'))
                console.log("edit user target ", e.target)

                var item = this.$.userList.itemForElement(e.target);
                console.log("selectedUser: ", item)
                this.selectedUser = item

                this.groupmember = e.model.get('item.groups')
                console.log("groupmember: ", this.groupmember);
                this._selectGroups(e.target)

                this.$.pages.select(2);
            }

            _handleSaveUser(e) {
                var valid = this.$.userForm.validate();

                if(valid){
                    console.log("saving... ", this.selectedUser)
                    this.$.saveUser.body = JSON.stringify(this.selectedUser);
                    console.log('body ', this.$.saveUser.body);

                    this.$.saveUser.url = this.userUrl + this.selectedUser.user;
                    this.$.saveUser.generateRequest();
                }
            }

            _handleUserSaved() {

                console.log('_handleUserSaved');
                this.$.messenger.text = 'changes have been saved.';
                this.$.messenger.open();
                this.$.pages.select(0);
                this.$.loadUserList.generateRequest();
            }

            _handleDeleteUser(e) {
                console.log("_handleDeleteUser");
                if(confirm('Really delete this user?')){
                    this.$.deleteUser.url= this.userUrl + this.selectedUser.user;
                    this.$.deleteUser.generateRequest();
                }
            }

            _handleUserDeleted(){
                this.$.pages.select(0);
                this.$.messenger.text = "User " + this.selectedUser.user + " has been deleted";
                this.$.messenger.open();
                this.$.loadUserList.generateRequest();
            }







            _isDeletable(userName) {
                return this.mode='edit';
            }

            _back(e){
                this.$.pages.select(0);
            }

            _usersChanged(val, foo) {
                console.log("############# users changed");
                console.log("val ", val, foo);
                this.$.userList.render()

//                if (this.users.length != 0) {
//                    console.log("users changed", this.users)
//                    //render must be called to update the UI when a new user has been added to the 'users' array
//                    this.$.userList.render()
//
//                    /*
//                     console.log("users changed this ", this);
//                     console.log("users changed this ", this.users.length - 1);
//                     console.log("######### users changed this ", this.$.userList.get(11));
//                     */
//                    var scope = this.$.userList.querySelectorAll('.user-entry')[11];
//                    console.log("last child: ", scope);
//                    var user = scope.querySelectorAll('.username')[0]
//                    if (user.value == '') {
//                        var detail = scope.querySelectorAll('.details')[0]
//                        detail.hidden = false
//                    }
//                }
            }

            _groupsChanged() {
                console.log("groups changed", this.users)
                this.$.userList.render()
            }


            _selectGroups() {
                this.$.memberOf.selectedValues = this.selectedUser.groups;
            }

            editGroup(e) {
                console.log("edit group ", e.model.get('item.group'));

                var groupid = e.model.get('item.group')
//                this._toggleDetails(e)
            }

/*
            _toggleDetails(e) {
                var target = e.target.parentNode
                console.log("toggle target ", e);
                console.log("toggle target ", e.target);
                console.log("toggle target ", e.target.parentNode);
                var elem = Polymer.dom(target).querySelector('.details')
                if (elem.hidden) {
                    elem.hidden = false
                    e.target.icon = 'expand-less'
                    //set selected values - in which group am i?
                } else {
                    elem.hidden = true
                    e.target.icon = 'expand-more'
                }
            }
*/


            _handleGroups() {
                this.groups = this.$.loadGroupList.lastResponse
            }

            _handleGroupListError(e) {
                console.log("error loading groups: ", e)
                //todo
            }

            _addGroup(e) {
                //todo
            }



            _handleAddGroup(e) {
                //todo
            }

            _handleGroupItem(e) {
                //todo: this does not work yet!
//                console.log("_handleGroups ", e);
//                console.log("_handleGroups ", e.model.get('users.user'));
//                console.log("groups for user ", this.$.userList.itemForElement(e.target));
//                var item = this.$.userList.itemForElement(e.model.dataHost.parentNode);


//                var item = this.$.userList.itemForElement(e.target);
//                var idx = this.users.indexOf(item)
//                console.log("group change idx: ", idx, e.target.label)
//
//                var entry = this.users[idx];
//                console.log("entry: ", entry);
//
////                var idx = this.users.length -1
//                this.splice('users.' + idx + '.groups', e.target.label)
//                this.notifyPath('users.*')
//                console.log("updated groups ", this.users)

//                console.log('_handleGroup target ', e.target);
                console.log('_handleGroup selectedUser ', this.selectedUser);
//                console.log('current index ', this.$.userList.indexForElement(e.target))

            }


        }

        window.customElements.define(ExistdbUsermanager.is, ExistdbUsermanager);
    </script>
</dom-module>

